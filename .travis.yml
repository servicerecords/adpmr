services:
  - docker
jobs:
  include:
    - stage: build image for sandbox
      if: branch = "docker_build"
      script:
        - echo "$DOCKER_SECRET" | docker login -u "$DOCKER_USER" docker.io --password-stdin
        - docker build -t build-image .
        - docker exec -it build-image bash -c './artisan dusk'
        - docker tag build-image:latest "$DOCKER_ORGANISATION"/srrdigital:sandbox
        - docker logout
        - echo "$DOCKER_SECRET" | docker login -u "$DOCKER_USER" docker.io --password-stdin
        - docker push "$DOCKER_ORGANISATION"/srrdigital:sandbox

      deploy:
        - provider: script
          skip_cleanup: true
          script: env CF_SPACE=development CF_APP_NAME=docker_deploy CF_MANIFEST=manifest-test.yml
#        - provider: cloudfoundry
#          api: https://api.cloud.service.gov.uk
#          username: toby@codesure.co.uk
#          password:
#            secure: aEz/q9GlioUg54PYP3qTytnvnfNJg+pgv8zGOKySXWuG1cfTbqOWFP+9DdJoJmbjQZGNwMeY19jnWcg2TGyqxFl+fb3qTnERk3cBIxle80WLSG2GCpCdieJYDUhQQRfMjQA7WPJU7NChBchHQbd0WjRx0L+9pXgIJwRKa9fd94ZZsxw5v0K4Xk+iAz3mhArazF8RjRtyWMRNcWMISYwI6O0jQeV+PPmI9OpT8X0dIN0rm0WrzvloKPSDgBMcrcYRUZxXVO1M2FIu6BNjJMp0BIaEvZthQ5+dyW+a1/b90onxwabpkPnb6sO0zSaaOpofnF8KMWz2GfAPrF/jz5DLgjSL/WatQqlBfFGS1nVx0PntTzB1oYhI390/gjiuDN2ghGF1/GY2biJ8mLcHhEWHxolVFV9kjGGw/kcLQgsrf4saeEv8j/CzW2ye3dyrAayavoJ0ZtMVh0yR5BNvAjgA+0R0nyOYgeqr3e53Mb9BnPTzj9pWrfEmkZRj/XDIuURjVxbZF4RFO0ddLHoIvEf6wDzwUVpi1EnmR8pdVaOsx55t2f6NAiZuiH9HqT+ZrGGlkB0QkHQUnG2kfic+oujFWrNhQY3YGn1r0Hnt9iQbnEtCmKqOk5Z4sSqDhLJmNK66emxhdZB2oAQ0XoMdNoNjIlQyUxlf5rNUEafPWWzFH3Q=
#          organization: mod-request-a-historic-service-record
#          space: development
#          on:
#            repo: servicerecords/mod-ssr
#            branch: docker_build
#          skip_cleanup: 'true'
#          manifest: manifest-sandbox.yml


notifications:
  email:
    recipients:
      #      - amanda.moran637@mod.gov.uk
      #      - liam.cusack582@mod.gov.uk
      - toby@codesure.co.uk
    on_success: always
    on_failure: always
#deploy:
#  - provider: cloudfoundry
#    api: https://api.cloud.service.gov.uk
#    username: "$CF_USERNAME"
#    password:
#      secure: "$CF_PASSWORD"
#    organization: mod-request-a-historic-service-record
#    space: development
#    on:
#      repo: servicerecords/mod-ssr
#    skip_cleanup: 'true'
#    manifest: manifest-sandbox.yml
#  - provider: cloudfoundry
#    api: https://api.cloud.service.gov.uk
#    username: "$CF_USERNAME"
#    password:
#      secure: "$CF_PASSWORD"
#    organization: mod-request-a-historic-service-record
#    space: development
#    on:
#      repo: servicerecords/mod-ssr
#    skip_cleanup: 'true'
#    manifest: manifest-qa.yml
